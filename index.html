<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Grounded Summarizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">
    <div id="app" class="w-full max-w-3xl bg-white shadow-2xl rounded-xl p-6 sm:p-10 border border-t-8 border-green-500">

        <header class="text-center mb-8 border-b pb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-green-700">Project TRUTH: Resilience & Grounding Service</h1>
            <p class="text-gray-500 mt-2">Demonstrates API stability via Exponential Backoff and verifiable data via Google Search Grounding.</p>
        </header>

        <!-- Input Area -->
        <div class="mb-8">
            <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">Primary Query for LLM</label>
            <textarea id="prompt" rows="3" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition shadow-sm resize-none" placeholder="e.g., What are the key features of the latest version of Tailwind CSS?"></textarea>
        </div>

        <!-- System Instruction (Advanced Control) -->
        <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <label for="systemInstruction" class="block text-sm font-semibold text-gray-700 mb-2">System Instruction (Persona Definition)</label>
            <textarea id="systemInstruction" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition shadow-sm resize-none" placeholder="e.g., Act as a concise technical writer. Only use 100 words." value="Act as a world-class technical analyst. Provide a professional, single-paragraph summary of the key findings."></textarea>
        </div>

        <button id="generateButton" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-300 disabled:opacity-50 flex items-center justify-center">
            <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Execute Grounded Query (Resilience Test)
        </button>

        <!-- Output Area -->
        <div id="outputContainer" class="mt-10 pt-6 border-t border-gray-200 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Grounded Output</h2>
            <div id="summaryText" class="p-5 bg-green-50 border-l-4 border-green-400 text-gray-700 rounded-lg leading-relaxed shadow-inner mb-6">
                <!-- Summary content will appear here -->
            </div>
            
            <!-- Source Citations -->
            <h3 class="text-lg font-semibold text-gray-600 mb-2 flex items-center">
                <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.102L13.828 9.828m2.53-2.53l4-4a4 4 0 015.656 0v0a4 4 0 010 5.656l-4 4"></path></svg>
                Verifiable Attributions (Grounding)
            </h3>
            <ul id="sourcesList" class="space-y-2 text-sm text-gray-600">
                <!-- Sources will appear here -->
            </ul>
            <div id="noSourcesMessage" class="hidden text-gray-500 mt-2">No external sources were required for this internal knowledge query.</div>
        </div>

        <!-- Error Message Box -->
        <div id="errorBox" class="mt-8 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg hidden">
            <p class="font-bold mb-1">Critical System Failure (API Level):</p>
            <p id="errorMessage"></p>
        </div>
    </div>

    <script>
        const API_KEY = ""; // Canvas environment provides this key automatically
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        
        const promptEl = document.getElementById('prompt');
        const systemInstructionEl = document.getElementById('systemInstruction');
        const generateButton = document.getElementById('generateButton');
        const spinner = document.getElementById('spinner');
        const outputContainer = document.getElementById('outputContainer');
        const summaryText = document.getElementById('summaryText');
        const sourcesList = document.getElementById('sourcesList');
        const noSourcesMessage = document.getElementById('noSourcesMessage');
        const errorBox = document.getElementById('errorBox');
        const errorMessageEl = document.getElementById('errorMessage');

        // --- Core Fetch Function with Exponential Backoff (Demonstrates resilience) ---
        const callGeminiApi = async (payload, maxRetries = 5) => {
            errorBox.classList.add('hidden');
            let lastError = null;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    }
                    
                    // Handle non-200 status codes
                    lastError = `API Error: Status ${response.status} - ${response.statusText}`;
                    if (response.status >= 500) {
                        // Retry on server errors
                        throw new Error(lastError);
                    } else if (response.status === 429) {
                        // Retry on rate limit
                        throw new Error(lastError);
                    } else {
                        // Do not retry on client errors (4xx)
                        return null; 
                    }

                } catch (error) {
                    lastError = error.message;
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000); // 1s, 2s, 4s, ... + jitter
                        await new Promise(resolve => setTimeout(resolve, delay));
                        // console.log(`Retry attempt ${i + 1} failed. Retrying in ${delay / 1000}s...`); // For debugging, suppress in production
                    }
                }
            }

            // After max retries, throw the last error
            throw new Error(`Maximum retries reached. Last error: ${lastError}`);
        };


        // --- Main Handler ---
        generateButton.addEventListener('click', async () => {
            const userQuery = promptEl.value.trim();
            const systemPrompt = systemInstructionEl.value.trim();

            if (!userQuery) {
                errorBox.classList.remove('hidden');
                errorMessageEl.textContent = "Please provide a query for the system to process.";
                return;
            }

            // UI State: Loading
            generateButton.disabled = true;
            spinner.classList.remove('hidden');
            summaryText.innerHTML = '<p class="text-gray-400 italic">Executing grounded query and analyzing system performance...</p>';
            sourcesList.innerHTML = '';
            outputContainer.classList.remove('hidden');
            errorBox.classList.add('hidden');
            noSourcesMessage.classList.add('hidden');


            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // MANDATORY for grounding
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const result = await callGeminiApi(payload);

                if (!result || !result.candidates || result.candidates.length === 0) {
                     throw new Error('Received an empty or malformed response from the API.');
                }
                
                const candidate = result.candidates[0];
                const text = candidate.content?.parts?.[0]?.text || "The model could not generate output for this query.";
                
                // 1. Update Generated Text
                summaryText.innerHTML = text.replace(/\n/g, '<br>');

                // 2. Extract and display sources
                const groundingMetadata = candidate.groundingMetadata;
                let sources = [];

                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title)
                        // Deduplicate sources by URI
                        .filter((source, index, self) => 
                            index === self.findIndex((s) => s.uri === source.uri)
                        ); 
                }

                if (sources.length > 0) {
                    sourcesList.innerHTML = sources.map((source, index) => `
                        <li class="flex items-start">
                            <span class="text-green-500 font-bold mr-2">${index + 1}.</span>
                            <a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="hover:text-green-600 hover:underline transition">
                                ${source.title}
                                <svg class="w-4 h-4 ml-1 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            </a>
                        </li>
                    `).join('');
                    noSourcesMessage.classList.add('hidden');
                } else {
                    sourcesList.innerHTML = '';
                    noSourcesMessage.classList.remove('hidden');
                }

            } catch (e) {
                console.error("Critical API or Processing Error:", e);
                errorBox.classList.remove('hidden');
                errorMessageEl.textContent = e.message || "An unexpected error occurred during API processing.";
                summaryText.innerHTML = '';
                sourcesList.innerHTML = '';
            } finally {
                // UI State: Ready
                generateButton.disabled = false;
                spinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
